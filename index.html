<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Kundli Report</title>
	
	 <style>
        /* General Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9fc;
            margin: 0;
            padding: 0;
            color: #333;
        }

        h2 {
            text-align: center;
            color: maroon; /* Maroon color for title */
            margin-top: 20px;
        }
		
		h3 {
            text-align: center;
            color: maroon; /* Maroon color for title */
            margin-top: 10px;
			font-size: 14px;

        }

        form {
            max-width: 800px;
            margin: 20px auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
        }

        .submit-button {
            width: 100%;
            background: linear-gradient(to right, #800000, #c20000); /* Gradient of maroon color */
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .submit-button:hover {
            background: linear-gradient(to right, #c20000, #800000);
        }

        #suggestions {
            position: absolute;
            border: 1px solid #ddd;
            background-color: #fff;
            max-height: 150px;
            overflow-y: auto;
            width: calc(55%);
            z-index: 1000;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        footer {
            text-align: center;
            margin: 20px 0;
            color: #555;
            font-size: 14px;
        }

        footer a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* WhatsApp green color for the WhatsApp Group link */
        .whatsapp-link {
            color: #25D366; /* WhatsApp green color */
        }
    </style>
</head>
<body>
    <h2>Kundli Report Automation</h2>
	 <p style="text-align: center; color: maroon; font-size: 12px;">
        So you can focus on Just Giving Predictions and Remedies
    </p>
    <form method="post">
        <div class="input-section">
            <label for="person-name">Name:</label>
            <input type="text" id="person-name" name="person_name" placeholder="Enter name" required>
        </div>

        <div class="input-section">
            <label for="dob">Date of Birth(dd-mm-yyyy):</label>
            <input type="date" id="dob" name="date_of_birth" value="1987-11-09" required>
        </div>

        <div class="input-section">
            <label for="tob">Time of Birth (IST):</label>
            <input type="time" id="tob" name="time_of_birth" value="12:00" required>
        </div>

        <div class="input-section">
            <label for="pob">Place of Birth:</label>
            <input type="text" id="pob" name="place_of_birth" placeholder="Enter your place of birth" required autocomplete="off">
            <div id="suggestions"></div>
        </div>

        <div class="input-section">
            <label for="varshfalYear">Select Lal Kitab Varshfal Year:</label>
            <select id="varshfalYear" name="varshfal_year"></select>
        </div>

        <div class="input-section">
            <label for="report-type">Select Course:</label>
            <select id="report-type" name="report_type" required>
                <option value="sango_saral_jyotish" disabled>Sango Saral Jyotish</option>
                <option value="transit" disabled>Transit</option>
                <option value="d10" disabled>Career (D10)</option>
                <option value="wealth_through_property" disabled>Wealth Through Property</option>
                <option value="astro_foundation" disabled>Astro Foundation</option>
                <option value="vimshottari" disabled>Vimshottari Dasha</option>
                <option value="lal_kitab" selected>Lal Kitab Advanced</option>
                <option value="vedic_remedies" disabled>Vedic Remedies</option>
                <option value="astro_vastu" disabled>Astro Vastu</option>
                <option value="match_making" disabled>Match Making</option>
                <option value="ashtak" disabled>Ashtakvarga</option>
            </select>
        </div>

        <button id="generateReportButton" type="submit" class="submit-button">Generate Report</button>
    </form>

<script>
    // Populate dropdown with Varshfal years
    document.getElementById('dob').addEventListener('change', function () {
        const dob = new Date(this.value);
        if (isNaN(dob)) return;

        const dropdown = document.getElementById('varshfalYear');
        dropdown.innerHTML = ''; // Clear previous options

        for (let i = 0; i < 80; i++) {
            const startYear = new Date(dob);
            startYear.setFullYear(startYear.getFullYear() + i);

            const endYear = new Date(dob);
            endYear.setFullYear(endYear.getFullYear() + i + 1);
            endYear.setDate(endYear.getDate() - 1);

            const option = document.createElement('option');
            option.value = i + 1;
            option.textContent = `Year ${i + 1}: ${startYear.getDate()}-${startYear.toLocaleString('default', { month: 'short' })}-${startYear.getFullYear()} to ${endYear.getDate()}-${endYear.toLocaleString('default', { month: 'short' })}-${endYear.getFullYear()}`;
            dropdown.appendChild(option);
        }
		
		dropdown.value = 25; // Select the 25th item (value is 25 since the loop assigns values starting from 1)

    });

    // Trigger change event to populate dropdown on page load
    document.getElementById('dob').dispatchEvent(new Event('change'));
	

    const input = document.getElementById('pob');
    const suggestionsBox = document.getElementById('suggestions');
    const apiKey = "22ad645923d64fe0b41d7993e83f7e12";
    const apiUrl = "https://api.geoapify.com/v1/geocode/autocomplete";
    let currentSuggestions = [];
    let selectedLocation = {};
	
	 // Convert timezone offset to decimal format
    function convertTimezoneToDecimal(timezone) {
        if (!timezone) return null; // Handle empty or invalid timezone
        const sign = timezone[0] === "-" ? -1 : 1;
        const [hours, minutes] = timezone.slice(1).split(":").map(Number);
        return sign * (hours + minutes / 60);
    }

    // Fetch location data from the new API
    async function fetchLocationData(query) {
        const url = `${apiUrl}?text=${encodeURIComponent(query)}&apiKey=${apiKey}`;
        try {
            const response = await fetch(url, { method: 'GET' });
            if (!response.ok) {
                console.error("API Error:", response.statusText);
                return [];
            }
            const result = await response.json();
            return result.features.map(feature => ({
                complete_name: feature.properties.formatted,
                latitude: feature.properties.lat,
                longitude: feature.properties.lon,
                location_name: feature.properties.address_line1,
                timezone_offset: convertTimezoneToDecimal(feature.properties.timezone.offset_STD),
            }));
        } catch (error) {
            console.error("Fetch error:", error);
            return [];
        }
    }

    // Render suggestions
    function renderSuggestions(data) {
        suggestionsBox.innerHTML = ''; // Clear previous suggestions
        if (data.length === 0) {
            suggestionsBox.style.display = 'none';
            return;
        }
        suggestionsBox.style.display = 'block';
        currentSuggestions = data;
        data.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = item.complete_name;
            div.setAttribute('data-index', index);
            div.addEventListener('click', () => handleSelection(index));
            suggestionsBox.appendChild(div);
        });
    }

    // Handle selection
    function handleSelection(index) {
        selectedLocation = currentSuggestions[index];
        input.value = selectedLocation.complete_name;
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
    }

    // Listen for input
    let debounceTimer; // Declare a timer for debouncing

input.addEventListener('input', function (event) {
    const query = event.target.value.trim();

    // Clear any existing timer
    clearTimeout(debounceTimer);

    // Set a new timer
    debounceTimer = setTimeout(async () => {
        if (query.length < 3) {
            suggestionsBox.innerHTML = '';
            suggestionsBox.style.display = 'none';
            return;
        }

        const data = await fetchLocationData(query);
        renderSuggestions(data);
    }, 1000); // 1000 ms delay
});


    // Form submission
    document.querySelector("form").addEventListener("submit", function (event) {
        event.preventDefault();

        const submitButton = document.querySelector("#generateReportButton");
        submitButton.disabled = true;
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = `<span class="spinner"></span> Processing...`;

        const formData = new FormData(this);
        const finalData = {
            person_name: formData.get("person_name"),
            date_of_birth: formData.get("date_of_birth"),
            time_of_birth: formData.get("time_of_birth"),
			varshfal_year: document.querySelector("#varshfalYear").selectedOptions[0].textContent,
            report_type: formData.get("report_type"),
            place_of_birth: {
                complete_name: selectedLocation.complete_name || formData.get("place_of_birth"),
                latitude: selectedLocation.latitude || null,
                longitude: selectedLocation.longitude || null,
                location_name: selectedLocation.location_name,
                timezone_offset: selectedLocation.timezone_offset,
            }
        };

        if (!finalData.place_of_birth.complete_name || (finalData.place_of_birth.latitude === null && finalData.place_of_birth.longitude === null)) {
            alert("Please enter a valid place of birth.");
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
            return;
        }

        console.log('finalData:', finalData);

        fetch("https://l5nni4kifmbex2l2w6vjltnvje0qyhgr.lambda-url.us-east-1.on.aws/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/pdf",
            },
            body: JSON.stringify(finalData),
        })
            .then(async (response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const disposition = response.headers.get("Content-Disposition");
                let filename = "lk-report.pdf";
                if (disposition && disposition.includes("filename=")) {
                    filename = disposition.split("filename=")[1].replace(/"/g, "");
                }

                const blob = await response.blob();
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("Error:", error);
                alert("There was an error processing the request: " + error.message);
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
    });
	
</script>

 <!-- Footer Section -->
<footer>
        <p>
            Connect with me on 
            <a href="https://www.linkedin.com/in/niket-singh/" target="_blank">LinkedIn</a> &nbsp;|&nbsp;
            Join our 
            <a href="https://chat.whatsapp.com/BZFCTI7UcNUAlOAiaCmHwx" target="_blank" class="whatsapp-link">WhatsApp Group</a>
        </p>
    </footer>
</body>
</html>
